<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CARBSE • Heatmap Generator (Type 1)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#2563eb;
      --brand-2:#1e40af;
      --line:#e5e7eb;
      --pill:#eef2ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
    .header{
      margin-bottom:18px;
      display:flex; align-items:center; justify-content:space-between;
    }
    h1{
      font-weight:600; font-size:22px; letter-spacing:.2px; margin:0;
    }
    .pill{background:var(--pill); color:var(--brand-2); padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600}
    .card{
      background:var(--card); border-radius:16px; box-shadow:0 8px 24px rgba(17,24,39,.06);
      border:1px solid var(--line); overflow:hidden; margin-bottom:18px;
    }
    .card .title{
      padding:14px 18px; border-bottom:1px solid var(--line); font-weight:600;
      background:linear-gradient(180deg,#fff, #fafbff);
    }
    .card .body{ padding:18px; }
    .row{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    @media (max-width: 900px){
      .col-6,.col-4,.col-3{grid-column:span 12}
    }
    label{display:block; font-size:12px; color:var(--muted); margin:6px 0 6px 2px}
    input[type="text"], input[type="number"], input[type="time"], select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); outline:none;
      font-size:14px; background:#fff;
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--brand); color:#fff; border:0; padding:10px 14px; border-radius:12px;
      font-weight:600; cursor:pointer; box-shadow:0 6px 16px rgba(37,99,235,.25);
    }
    .btn.secondary{ background:#eef2ff; color:var(--brand-2); box-shadow:none; }
    .btn.icon{ padding:8px 10px }
    .muted{ color:var(--muted); }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px }
    .tabs{ display:flex; gap:12px; border-bottom:1px solid var(--line); padding:0 18px }
    .tab{
      padding:12px 10px; font-weight:600; color:var(--muted); border-bottom:2px solid transparent; cursor:pointer; text-decoration:none;
    }
    .tab.active{ color:var(--brand-2); border-color:var(--brand-2) }
    .plot-card{ padding: 6px 18px 18px }
    .plot-wrap{ background:#fff; border-radius:12px; border:1px solid var(--line); padding:12px; }
    /* Keep plot inside the card */
    .plot-wrap{ overflow:hidden; }
    .plot-wrap .js-plotly-plot,
    .plot-wrap .plot-container,
    .plot-wrap .plotly,
    .plot-wrap svg,
    .plot-wrap .main-svg {
      max-width:100% !important;
    }
    .kgroup{
      display:flex; flex-wrap:wrap; gap:16px; align-items:end;
    }
    .color-grid{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:6px; }
    .color-grid label{ display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid var(--line); border-radius:10px; cursor:pointer; }
    .footer-note{ text-align:center; color:var(--muted); font-size:12px; padding:24px 0 6px }
    table { border-collapse: collapse; width: 100%;}
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--line); }
    th { background: #f9fafb; text-align: left; font-weight:600 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>CARBSE • Heatmap Generator (Type 1)</h1>
      <div class="pill">Single City</div>
    </div>

    <!-- Upload -->
    <div class="card">
      <div class="title">1) Upload CSV</div>
      <div class="body">
        <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data" class="kgroup">
          <div class="col-6">
            <label>Choose CSV/XLSX <span class="muted">(Expected headers: <b>Timestamp, DBT, RH</b>)</span></label>
            <input type="file" name="file" accept=".csv,.xlsx,.xls"/>
          </div>
          <div>
            <button class="btn" type="submit">Upload</button>
          </div>
        </form>
        {% if detected_cols %}
          <div class="hint">Detected columns: {{ detected_cols|join(", ") }}</div>
        {% endif %}
      </div>
    </div>

    <!-- Configure -->
    <div class="card">
      <div class="title">2) Configure & Generate</div>
      <div class="body">
        <form method="post" action="{{ url_for('generate_heatmap') }}">
          <div class="row">
            <div class="col-3">
              <label>Variable</label>
              <select name="variable" id="variable">
                <option value="DBT">DBT</option>
                <option value="RH">RH</option>
              </select>
            </div>
            <div class="col-3">
              <label>Scale minimum</label>
              <input type="number" step="any" name="scale_min" placeholder="0"/>
            </div>
            <div class="col-3">
              <label>Scale maximum</label>
              <input type="number" step="any" name="scale_max" id="scale_max" placeholder="DBT→50, RH→100"/>
            </div>
            <div class="col-3">
              <label>Missing value color</label>
              <select name="missing_color">
                <option>Grey</option>
                <option>White</option>
                <option>Black</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <div class="col-3">
              <label>Upper band time</label>
              <input type="time" name="upper_band_time" value="09:00"/>
            </div>
            <div class="col-3">
              <label>Type</label>
              <select name="upper_band_style">
                <option value="dotted" selected>dotted</option>
                <option value="solid">solid</option>
              </select>
            </div>
            <div class="col-3">
              <label>Color</label>
              <select name="upper_band_color">
                <option>black</option><option>red</option><option>blue</option><option>yellow</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:4px">
            <div class="col-3">
              <label>Lower band time</label>
              <input type="time" name="lower_band_time" value="18:00"/>
            </div>
            <div class="col-3">
              <label>Type</label>
              <select name="lower_band_style">
                <option value="dotted" selected>dotted</option>
                <option value="solid">solid</option>
              </select>
            </div>
            <div class="col-3">
              <label>Color</label>
              <select name="lower_band_color">
                <option>black</option><option>red</option><option>blue</option><option>yellow</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="col-12">
              <label>Select range of colours</label>
              <div class="color-grid">
                {% for c in ["White","Navyblue","Blue","Cyan","Yellow","Red","Darkred","Black"] %}
                  <label><input type="checkbox" name="colors" value="{{ c }}" {% if c in ["Blue","Cyan","Yellow","Red"] %}checked{% endif %}> {{ c }}</label>
                {% endfor %}
              </div>
              <div class="hint">Choose 2–8 colors; order matters (left→right).</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="col-3">
              <label>Date axis format</label>
              <select name="date_fmt">
                <option value="mon2y" selected>Abbrev. month – 2-digit year (Jan-17)</option>
                <option value="ddmmyy">Decimal date – 2-digit year (01-01-17)</option>
                <option value="ddmonfull">Decimal date – Full month (01-January)</option>
                <option value="mon3">Abbrev. month (Jan)</option>
                <option value="ddmon">Day-month (01-Jan)</option>
                <option value="dow3">Abbrev. weekday (Mon)</option>
                <option value="dowfull">Full weekday (Monday)</option>
                <option value="mm">2-digit month (01)</option>
                <option value="yyyy">4-digit year (2017)</option>
              </select>
            </div>
            <div class="col-3">
              <label>X-axis represented by</label>
              <select name="x_repr">
                <option value="months" selected>months</option>
                <option value="days">days</option>
              </select>
            </div>
            <div class="col-3">
              <label>Image width (px)</label>
              <input type="number" name="image_width" value="1200"/>
            </div>
            <div class="col-3">
              <label>Image height (px)</label>
              <input type="number" name="image_height" value="600"/>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="col-4">
              <label>Title</label>
              <input type="text" name="title" placeholder="Heatmap"/>
            </div>
            <div class="col-4">
              <label>X-axis name</label>
              <input type="text" name="x_name" value="Date"/>
            </div>
            <div class="col-4">
              <label>Y-axis name</label>
              <input type="text" name="y_name" value="Hour"/>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="col-4">
              <label>Legend name</label>
              <input type="text" name="legend_name" id="legend_name" placeholder="DBT / RH"/>
            </div>
          </div>

          <div style="margin-top:16px; display:flex; gap:10px; align-items:center">
            <button class="btn" type="submit">Generate Heatmap</button>
            {% if last_plot_id %}
              <a class="btn secondary" href="{{ url_for('download_jpg', plot_id=last_plot_id) }}">Download JPG</a>
            {% endif %}
          </div>
          <div class="hint" style="margin-top:8px">Web plot is responsive to the card; JPG uses your fixed width/height.</div>
        </form>
      </div>
    </div>

    <!-- Tabs / Plot + Data -->
    <div class="card">
      <div class="tabs">
        <a class="tab active">Heatmap</a>
        <a class="tab">Data</a>
      </div>
      <div class="plot-card">
        <div class="plot-wrap">
          {% if plot_html %}
            {{ plot_html|safe }}
          {% elif not has_data %}
            <div class="muted" style="padding:16px">No plot yet. Upload a CSV and click <b>Generate Heatmap</b>.</div>
          {% else %}
            <div class="muted" style="padding:16px">Upload done. Configure options above and click <b>Generate Heatmap</b>.</div>
          {% endif %}
        </div>
      </div>
      <div class="body">
        {% if data_html %}
          <div class="muted" style="margin-bottom:6px">Preview (first 100 rows)</div>
          {{ data_html|safe }}
        {% endif %}
      </div>
    </div>

    <div class="footer-note">© 2025 CARBSE • Built with Flask + Plotly</div>
  </div>

  <script>
    // Auto default scale max based on variable
    const variableSel = document.getElementById('variable');
    const scaleMaxInp = document.getElementById('scale_max');
    const legendInp   = document.getElementById('legend_name');

    function setDefaults() {
      const v = (variableSel?.value || "DBT").toUpperCase();
      if(!scaleMaxInp.value){
        scaleMaxInp.placeholder = v === "DBT" ? "50" : "100";
      }
      if(!legendInp.value){
        legendInp.placeholder = v;
      }
    }
    variableSel?.addEventListener('change', setDefaults);
    setDefaults();

    // Resize safeguard (usually not needed because config.responsive = true)
    window.addEventListener('resize', () => {
      const gd = document.querySelector('.plot-wrap .js-plotly-plot');
      if (gd && window.Plotly) Plotly.Plots.resize(gd);
    });
  </script>
</body>
</html>
