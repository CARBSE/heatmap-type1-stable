<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CARBSE Heatmap Generator</title>

  <!-- Inter font + minimal CSS reset -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#eef2f7; --card:#fff; --ink:#0f172a; --muted:#64748b; --primary:#0ea5e9; --border:#e5e7eb;
      --accent:#f1f5f9;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:14px/1.4 Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial;
    }
    .container{max-width:1280px; margin:32px auto; padding:0 16px}
    .hstack{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    .vstack{display:flex; gap:16px; flex-direction:column}
    .grid{display:grid; gap:16px}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px;
      box-shadow:0 1px 2px rgba(15,23,42,.04);
    }
    h1{font-size:20px; margin:0 0 12px}
    h2{font-size:16px; margin:0 0 12px}
    label{font-weight:600; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.04em}
    input[type="text"], input[type="number"], select{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff;
      outline:none; transition:border-color .15s ease; font-size:14px;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus{border-color:#94a3b8}
    .btn{
      appearance:none; border:1px solid transparent; border-radius:10px; padding:10px 14px; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:600; font-size:14px;
      transition:transform .05s ease, background .15s ease, box-shadow .15s ease;
      box-shadow:0 1px 2px rgba(14,165,233,.25);
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#fff; color:var(--ink); border-color:var(--border)}
    .muted{color:var(--muted)}
    .row{display:grid; gap:16px}
    @media(min-width:1000px){
      .row.top {grid-template-columns: 1fr 1fr 1fr 1fr}
      .row.bottom {grid-template-columns: 1fr}
    }
    /* Tabs */
    .tabs{display:flex; gap:8px; border-bottom:1px solid var(--border); margin-bottom:8px}
    .tab{padding:8px 12px; border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0; background:#fff; cursor:pointer}
    .tab.active{background:var(--accent)}
    .hidden{display:none}
    /* Data table */
    table{border-collapse:collapse; width:100%; font-size:13px}
    th,td{padding:8px 10px; border-bottom:1px solid var(--border); text-align:left}
    th{background:var(--accent); font-weight:600}
    .pill{padding:4px 8px; background:var(--accent); border-radius:999px; font-size:12px}
    .grow{flex:1}
  </style>
</head>
<body>
  <div class="container vstack">
    <h1>CARBSE Heatmap Generator</h1>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="vstack">
          {% for cat, msg in messages %}
            <div class="card" style="border-left:4px solid {% if cat=='danger' %#ef4444{% elif cat=='warning'%#f59e0b{% else %}#22c55e{% endif %};">
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- CONTROLS (top) -->
    <form method="post" action="{{ url_for('generate_heatmap') }}" class="card vstack">
      <h2>1) Upload & Settings</h2>
      <div class="row top">

        <!-- Upload box (separate POST via /upload for file content) -->
        <div class="vstack">
          <label>CSV / Excel</label>
          <div class="hstack">
            <input class="grow" type="file" name="file" form="upload-form" accept=".csv,.xls,.xlsx"/>
            <button class="btn" type="submit" form="upload-form">Upload</button>
          </div>
          <div class="muted" style="font-size:12px">Expected columns: <b>Timestamp, DBT, RH</b></div>
          {% if file_id %}
            <div class="pill">Uploaded: <code>data.csv</code></div>
          {% endif %}

          {% if columns %}
            <div class="muted" style="font-size:12px; margin-top:6px">Detected columns: {{ ", ".join(columns) }}</div>
          {% endif %}
        </div>

        <!-- Variable + scale -->
        <div class="vstack">
          <label>Parameter</label>
          <div class="hstack">
            <label><input type="radio" name="parameter" value="DBT" {% if (defaults.param or request.form.get('parameter','DBT'))=='DBT' %}checked{% endif %}> DBT</label>
            <label><input type="radio" name="parameter" value="RH"  {% if (defaults.param or request.form.get('parameter'))=='RH' %}checked{% endif %}> RH</label>
          </div>
          <div class="hstack">
            <div class="vstack" style="min-width:140px">
              <label>Scale Min</label>
              <input type="number" step="any" name="scale_min" value="{{ defaults.scale_min or request.form.get('scale_min','') }}" placeholder="auto">
            </div>
            <div class="vstack" style="min-width:140px">
              <label>Scale Max</label>
              <input type="number" step="any" name="scale_max" value="{{ defaults.scale_max or request.form.get('scale_max','') }}" placeholder="auto">
            </div>
          </div>
          <div class="vstack">
            <label>Legend step (tick)</label>
            <input type="number" step="any" name="legend_step" value="{{ defaults.legend_step or request.form.get('legend_step','10') }}">
          </div>
        </div>

        <!-- Bands + missing colour -->
        <div class="vstack">
          <label>Band lines (optional)</label>
          <div class="hstack">
            <div class="vstack">
              <small class="muted">Upper time</small>
              <input type="text" name="upper_time" value="{{ defaults.upper_time or '09:00' }}">
            </div>
            <div class="vstack">
              <small class="muted">Style</small>
              <select name="upper_style">
                {% for st in ['dotted','dashed','solid'] %}
                  <option value="{{st}}" {% if (defaults.upper_style or 'dotted')==st %}selected{% endif %}>{{st}}</option>
                {% endfor %}
              </select>
            </div>
            <div class="vstack">
              <small class="muted">Colour</small>
              <select name="upper_color">
                {% for c in ['black','red','blue','cyan'] %}
                  <option value="{{c}}" {% if (defaults.upper_color or 'black')==c %}selected{% endif %}>{{c}}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="hstack">
            <div class="vstack">
              <small class="muted">Lower time</small>
              <input type="text" name="lower_time" value="{{ defaults.lower_time or '18:00' }}">
            </div>
            <div class="vstack">
              <small class="muted">Style</small>
              <select name="lower_style">
                {% for st in ['dotted','dashed','solid'] %}
                  <option value="{{st}}" {% if (defaults.lower_style or 'dotted')==st %}selected{% endif %}>{{st}}</option>
                {% endfor %}
              </select>
            </div>
            <div class="vstack">
              <small class="muted">Colour</small>
              <select name="lower_color">
                {% for c in ['black','red','blue','cyan'] %}
                  <option value="{{c}}" {% if (defaults.lower_color or 'black')==c %}selected{% endif %}>{{c}}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="vstack">
            <label>Missing value colour</label>
            <select name="nodata_color">
              {% for c in ['Grey','White','Black','Red','Blue','Cyan','Yellow'] %}
                <option value="{{c}}" {% if (defaults.nodata_color or 'Grey')==c %}selected{% endif %}>{{c}}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Labels / date format / sizes -->
        <div class="vstack">
          <label>Labels & Date</label>
          <input type="hidden" name="file_id" value="{{ file_id or '' }}">
          <input type="text" name="title"  placeholder="Title" value="{{ defaults.title or '' }}">
          <div class="hstack">
            <input class="grow" type="text" name="xname" placeholder="X-axis name" value="{{ defaults.xname or 'Date' }}">
            <input class="grow" type="text" name="yname" placeholder="Y-axis name" value="{{ defaults.yname or 'Hour' }}">
          </div>
          <input type="text" name="lname" placeholder="Legend name" value="{{ defaults.lname or 'Legend' }}">

          <div class="hstack">
            <div class="vstack">
              <small class="muted">X tick format</small>
              <select name="tickformat">
                <option value="mon_abbr_2digit_year" {% if (defaults.tickformat or 'mon_abbr_2digit_year')=='mon_abbr_2digit_year' %}selected{% endif %}>Jan-17</option>
                <option value="mon_abbr" {% if (defaults.tickformat)=='mon_abbr' %}selected{% endif %}>Jan</option>
                <option value="month_full" {% if (defaults.tickformat)=='month_full' %}selected{% endif %}>January</option>
                <option value="mon_dec_2digit_year" {% if (defaults.tickformat)=='mon_dec_2digit_year' %}selected{% endif %}>01-17</option>
                <option value="mon_dec" {% if (defaults.tickformat)=='mon_dec' %}selected{% endif %}>01</option>
                <option value="weekday_abbr" {% if (defaults.tickformat)=='weekday_abbr' %}selected{% endif %}>Mon</option>
                <option value="weekday_full" {% if (defaults.tickformat)=='weekday_full' %}selected{% endif %}>Monday</option>
                <option value="year_2digit" {% if (defaults.tickformat)=='year_2digit' %}selected{% endif %}>17</option>
                <option value="year_4digit" {% if (defaults.tickformat)=='year_4digit' %}selected{% endif %}>2017</option>
              </select>
            </div>
            <div class="vstack">
              <small class="muted">X axis represented by</small>
              <select name="x_representation">
                {% for xrep in ['months','quarters','years','weeks','days'] %}
                  <option value="{{xrep}}" {% if (defaults.x_representation or 'months')==xrep %}selected{% endif %}>{{xrep}}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="hstack">
            <div class="vstack">
              <small class="muted">Image width</small>
              <input type="number" name="width" value="{{ defaults.width or '1200' }}">
            </div>
            <div class="vstack">
              <small class="muted">Image height</small>
              <input type="number" name="height" value="{{ defaults.height or '600' }}">
            </div>
            <div class="vstack">
              <small class="muted">Base font (pt)</small>
              <input type="number" name="base_font" value="{{ defaults.base_font or '15' }}">
            </div>
          </div>
        </div>

      </div>

      <!-- Color choices row -->
      <div class="card" style="background:#fbfdff">
        <div class="hstack" style="gap:12px; flex-wrap:wrap">
          <label>Colourscale:</label>
          {% set chosen = defaults.colors or request.form.getlist('colors') %}
          {% for name in ['White','Navyblue','Blue','Cyan','Yellow','Red','Darkred','Black'] %}
            <label><input type="checkbox" name="colors" value="{{name}}"
                          {% if name in chosen %}checked{% endif %}> {{name}}</label>
          {% endfor %}
          <span class="muted">(Left→Right = low→high)</span>
        </div>
      </div>

      <div class="hstack" style="justify-content:flex-start">
        <button class="btn" type="submit">Generate heatmap</button>
        {% if plot_id %}
          <a class="btn secondary" href="{{ url_for('download_jpg', plot_id=plot_id) }}">Download JPG</a>
        {% endif %}
      </div>
    </form>

    <!-- UPLOAD helper form -->
    <form id="upload-form" method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data"></form>

    <!-- OUTPUT (bottom) -->
    <div class="grid bottom">
      <div class="card vstack">
        <div class="tabs">
          <div class="tab active" data-tab="heat">Heatmap</div>
          <div class="tab" data-tab="data">Data</div>
        </div>

        <div id="tab-heat">
          {% if fig_html %}
            <div style="overflow:auto">{{ fig_html|safe }}</div>
          {% else %}
            <div class="muted">No plot yet. Upload a CSV and click <b>Generate heatmap</b>.</div>
          {% endif %}
        </div>

        <div id="tab-data" class="hidden">
          {% if preview %}
            <div class="muted" style="margin-bottom:6px">Preview (first 30 rows)</div>
            <div style="max-height:420px; overflow:auto; border:1px solid var(--border); border-radius:10px">
              <table>
                <thead>
                  <tr>
                    {% for c in columns %}
                      <th>{{ c }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for row in preview %}
                    <tr>
                      {% for c in columns %}
                        <td>{{ row[c] }}</td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="muted">Upload a CSV to see a data preview.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    // Simple tabs
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('tab-heat').classList.toggle('hidden', t.dataset.tab !== 'heat');
      document.getElementById('tab-data').classList.toggle('hidden', t.dataset.tab !== 'data');
    }));
  </script>
</body>
</html>
