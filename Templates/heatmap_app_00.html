<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CARBSE • Heatmap Generator (Type 1)</title>

  <!-- Fonts & CSS -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    :root{
      --brand:#1e293b;        /* slate-800 */
      --brand-2:#0ea5e9;      /* sky-500 */
      --bg:#f8fafc;           /* slate-50 */
      --card:#ffffff;
      --muted:#64748b;        /* slate-500 */
      --ring:#cbd5e1;         /* slate-300 */
    }
    html,body{height:100%; background:var(--bg); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";}

    .navbar{
      background:linear-gradient(90deg, var(--brand), #0b3b5e);
    }
    .navbar-brand{
      font-weight:700; letter-spacing:.3px; color:#fff !important;
    }

    .page-wrap{ padding: 28px 16px 36px; }
    .card{
      border:1px solid var(--ring);
      box-shadow: 0 10px 16px rgba(2, 6, 23, .04);
      border-radius:16px;
    }
    .card-header{
      background: linear-gradient(180deg, #ffffff, #f8fafc);
      border-bottom:1px solid var(--ring);
      border-top-left-radius:16px; border-top-right-radius:16px;
    }
    .card-title{ font-weight:600; margin:0; color:#0f172a;}
    .btn-brand{
      background:var(--brand-2); border:none;
    }
    .btn-brand:hover{
      background:#0284c7;
    }
    .btn-outline-brand{
      border:1px solid var(--brand-2); color:var(--brand-2);
    }
    .btn-outline-brand:hover{
      background:var(--brand-2); color:#fff;
    }
    .form-label{ font-weight:500; color:#0f172a;}
    .form-text{ color: var(--muted); }
    .form-control, .form-select{
      border-radius:10px;
    }

    /* Plot container makes Plotly responsive without overflowing the card */
    .plot-card-body{
      height: 560px; /* visible plotting space */
      padding: 0.75rem 0.75rem 1rem;
    }
    .plot-wrap{
      width: 100%;
      height: 100%;
      overflow: hidden; /* avoid spilling out of the card */
    }
    /* Force Plotly div to fit the container */
    .plot-wrap .js-plotly-plot, .plot-wrap .plotly-graph-div{
      width: 100% !important;
      height: 100% !important;
    }

    /* Preview table scroll */
    .table-scroll{
      max-height: 280px; overflow:auto; border:1px solid var(--ring); border-radius:10px; padding: 4px;
      background: #fff;
    }

    footer{
      color: var(--muted); font-size: .9rem;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg mb-0">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">CARBSE Heatmap Generator</a>
  </div>
</nav>

<div class="page-wrap container-fluid">

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mb-3">
    {% for category, message in messages %}
      <div class="alert alert-{{ 'warning' if category=='warning' else ('danger' if category=='danger' else ('success' if category=='success' else 'secondary')) }} shadow-sm" role="alert">
        {{ message }}
      </div>
    {% endfor %}
    </div>
  {% endif %}
  {% endwith %}

  <div class="row g-4">
    <!-- Left: Upload & Controls -->
    <div class="col-12 col-lg-5">
      <div class="card mb-4">
        <div class="card-header py-3">
          <h5 class="card-title">1) Upload Data</h5>
        </div>
        <div class="card-body">
          <form action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data" class="row g-3">
            <div class="col-12">
              <label class="form-label">CSV / Excel file</label>
              <input class="form-control" type="file" name="file" accept=".csv,.xlsx,.xls" required>
              <div class="form-text">Expected columns: <code>Timestamp</code>, <code>DBT</code>, <code>RH</code></div>
            </div>
            <div class="col-12 d-flex gap-2">
              <button class="btn btn-brand px-4" type="submit">Upload</button>
              {% if filename %}
                <span class="align-self-center text-muted ms-1">Uploaded: <strong>{{ filename }}</strong></span>
              {% endif %}
            </div>
          </form>

          {% if preview_table %}
            <div class="mt-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="h6 mb-0">Preview (first 30 rows)</div>
                {% if columns %}
                  <span class="badge bg-light text-dark border">Columns: {{ columns|length }}</span>
                {% endif %}
              </div>
              <div class="table-scroll">
                {{ preview_table|safe }}
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="card-header py-3">
          <h5 class="card-title">2) Configure & Generate</h5>
        </div>
        <div class="card-body">
          <form action="{{ url_for('generate_heatmap') }}" method="POST" class="row gy-3">
            <!-- Parameter -->
            <div class="col-12">
              <label class="form-label">Parameter</label>
              <div class="d-flex gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="parameter" id="param_dbt" value="DBT"
                         {% if selected_param %}{% if selected_param=='DBT' %}checked{% endif %}{% else %}checked{% endif %}>
                  <label class="form-check-label" for="param_dbt">DBT</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="parameter" id="param_rh" value="RH"
                         {% if selected_param and selected_param=='RH' %}checked{% endif %}>
                  <label class="form-check-label" for="param_rh">RH</label>
                </div>
              </div>
              <div class="form-text">Heatmap colorscale defaults: DBT 0–50, RH 0–100 (you can override below).</div>
            </div>

            <!-- Scale min/max -->
            <div class="col-6">
              <label class="form-label">Scale Min</label>
              <input class="form-control" type="number" step="any" name="scale_min"
                     value="{{ default_vmin if default_vmin is defined else 0 }}">
            </div>
            <div class="col-6">
              <label class="form-label">Scale Max</label>
              <input class="form-control" type="number" step="any" name="scale_max"
                     id="scale_max"
                     value="{% if default_vmax is defined %}{{ default_vmax }}{% elif selected_param=='RH' %}100{% else %}50{% endif %}">
            </div>

            <div class="col-12 d-flex gap-2">
              <button class="btn btn-brand px-4" type="submit">Generate heatmap</button>
              {% if image_url %}
                <a class="btn btn-outline-brand px-4" href="{{ image_url }}">Download JPG</a>
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Right: Plot -->
    <div class="col-12 col-lg-7">
      <div class="card h-100">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">3) Heatmap Output</h5>
          <span class="text-muted small">Responsive view</span>
        </div>
        <div class="card-body plot-card-body">
          <div class="plot-wrap">
            {% if graph_html %}
              {{ graph_html|safe }}
            {% else %}
              <div class="h-100 d-flex align-items-center justify-content-center text-muted">
                Upload data and click <b>Generate heatmap</b> to see the chart here.
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center mt-4">
    © 2025 CARBSE • Built with Flask & Plotly
  </footer>
</div>

<script>
  // Adjust Scale Max when user toggles DBT/RH (defaults DBT=50, RH=100)
  const dbt = document.getElementById('param_dbt');
  const rh  = document.getElementById('param_rh');
  const scaleMax = document.getElementById('scale_max');
  function setDefaultMax(){
    if (!scaleMax) return;
    if (rh && rh.checked) scaleMax.value = 100;
    else scaleMax.value = 50;
  }
  if (dbt) dbt.addEventListener('change', setDefaultMax);
  if (rh)  rh.addEventListener('change', setDefaultMax);
</script>

</body>
</html>
